name: ðŸ› ï¸ Setup Security Files Generator

on:
  workflow_dispatch:
    inputs:
      sonar_project_key:
        description: '1. Sonar Project Key'
        required: true
        type: string
      sonar_organization:
        description: '2. Sonar Organization'
        required: true
        type: string

permissions:
  contents: write
  workflows: write # FONDAMENTALE: Permette di creare file .yml nella cartella workflows

jobs:
  generate-config:
    name: Generate Configuration Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Detect Project Type & Generate Files
        run: |
          echo "ðŸ” Analisi del repository in corso..."
          
          # 1. Rilevamento Tipo Progetto
          PROJECT_TYPE="generic"
          BUILD_CMD="echo 'No build command detected'"
          SONAR_BINARIES=""
          CODEQL_LANGS="['javascript']"

          if [ -f "pom.xml" ]; then
              echo "ðŸ“¦ Rilevato progetto MAVEN"
              PROJECT_TYPE="maven"
              BUILD_CMD="mvn clean verify -DskipTests"
              SONAR_BINARIES="**/target/classes"
              CODEQL_LANGS="['java']"
          elif [ -f "gradlew" ] || [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
              echo "ðŸ˜ Rilevato progetto GRADLE"
              PROJECT_TYPE="gradle"
              BUILD_CMD="./gradlew assemble --no-daemon"
              SONAR_BINARIES="**/build/classes/java/main,**/build/tmp/kotlin-classes/debug"
              CODEQL_LANGS="['java']"
          elif [ -f "go.mod" ]; then
              echo "ðŸ¹ Rilevato progetto GO"
              PROJECT_TYPE="go"
              BUILD_CMD="go build ./..."
              SONAR_BINARIES=""
              CODEQL_LANGS="['go']"
          elif [ -f "package.json" ]; then
              echo "ðŸŸ¢ Rilevato progetto NODE/JS"
              PROJECT_TYPE="javascript"
              BUILD_CMD="npm install && npm run build --if-present"
              SONAR_BINARIES=""
              CODEQL_LANGS="['javascript']"
          fi

          echo "âœ… Tipo rilevato: $PROJECT_TYPE"

          # 2. Generazione sonar-project.properties
          echo "ðŸ“ Creazione sonar-project.properties..."
          cat > sonar-project.properties <<EOF
          sonar.projectKey=${{ inputs.sonar_project_key }}
          sonar.organization=${{ inputs.sonar_organization }}
          sonar.sources=.
          sonar.sourceEncoding=UTF-8
          sonar.exclusions=**/*.java, **/*.class, **/build/**, **/.gradle/**, **/node_modules/**, **/*.test.js, **/venv/**, **/.idea/**, **/*.png, **/*.xml, **/*.json, **/target/**, **/*.jar, **/*.apk
          sonar.java.binaries=$SONAR_BINARIES
          sonar.python.version=3.10
          EOF

          # 3. Generazione Snyk.yml
          echo "ðŸ”¨ Creazione .github/workflows/Snyk.yml..."
          cat > .github/workflows/Snyk.yml <<EOF
          name: Snyk Security
          on:
            push:
              branches: [ "main", "develop", "master" ]
              paths-ignore:
                - '.github/workflows/**'
                - 'sonar-project.properties'
            pull_request:
              branches: [ "main", "develop", "master" ]
              paths-ignore:
                - '.github/workflows/**'
                - 'sonar-project.properties'
          jobs:
            snyk-scan:
              name: Snyk Security Check
              runs-on: ubuntu-latest
              permissions:
                contents: read
                security-events: write
              steps:
                - uses: actions/checkout@v4
                - name: Set up JDK 21
                  uses: actions/setup-java@v4
                  with:
                    java-version: '21'
                    distribution: 'temurin'
                - name: Install Snyk Tools
                  run: |
                    npm install snyk-to-html -g
                    npm install snyk -g
                - name: Build Project
                  run: |
                    if [ -f "gradlew" ]; then chmod +x gradlew; fi
                    $BUILD_CMD
                - name: Run Snyk Test (JSON)
                  continue-on-error: true
                  env:
                    SNYK_TOKEN: \${{ secrets.SNYK_TOKEN }}
                  run: snyk test --all-projects --json > snyk_report.json
                - name: Convert to HTML
                  run: snyk-to-html -i snyk_report.json -o snyk_report.html
                - name: Monitor
                  continue-on-error: true
                  env:
                    SNYK_TOKEN: \${{ secrets.SNYK_TOKEN }}
                  run: snyk monitor --all-projects
                - name: Quality Gate
                  env:
                    SNYK_TOKEN: \${{ secrets.SNYK_TOKEN }}
                  run: snyk test --all-projects --fail-on=high || echo "High vulnerabilities found"
                - name: Upload Artifact
                  uses: actions/upload-artifact@v4
                  if: always()
                  with:
                    name: snyk-report
                    path: snyk_report.html
          EOF

          # 4. Generazione SonarCloud.yml
          echo "â˜ï¸ Creazione .github/workflows/SonarCloud.yml..."
          cat > .github/workflows/SonarCloud.yml <<EOF
          name: SonarCloud
          on:
            push:
              branches: [ "main", "develop", "master" ]
              paths-ignore:
                - '.github/workflows/**'
                - 'sonar-project.properties'
            pull_request:
              branches: [ "main", "develop", "master" ]
              paths-ignore:
                - '.github/workflows/**'
                - 'sonar-project.properties'
          jobs:
            sonar-scan:
              name: SonarCloud Scan
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                  with:
                    fetch-depth: 0
                - name: Set up JDK 21
                  uses: actions/setup-java@v4
                  with:
                    java-version: '21'
                    distribution: 'temurin'
                - name: Cache SonarCloud packages
                  uses: actions/cache@v4
                  with:
                    path: ~/.sonar/cache
                    key: \${{ runner.os }}-sonar
                    restore-keys: \${{ runner.os }}-sonar
                - name: Build Project
                  run: |
                    if [ -f "gradlew" ]; then chmod +x gradlew; fi
                    $BUILD_CMD
                - name: Analyze with SonarCloud
                  uses: SonarSource/sonarcloud-github-action@master
                  env:
                    GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}
                    SONAR_TOKEN: \${{ secrets.SONAR_TOKEN }}
                  with:
                    args: >
                      -Dsonar.qualitygate.wait=true
          EOF

          # 5. Generazione CodeQL.yml
          echo "ðŸ” Creazione .github/workflows/CodeQL.yml..."
          cat > .github/workflows/CodeQL.yml <<EOF
          name: CodeQL
          on:
            push:
              branches: [ "main" ]
              paths-ignore:
                - '.github/workflows/**'
                - 'sonar-project.properties'
            pull_request:
              branches: [ "main" ]
              paths-ignore:
                - '.github/workflows/**'
                - 'sonar-project.properties'
            schedule:
              - cron: '30 1 * * 0'
          jobs:
            analyze:
              name: Analyze
              runs-on: ubuntu-latest
              permissions:
                actions: read
                contents: read
                security-events: write
              strategy:
                fail-fast: false
                matrix:
                  language: $CODEQL_LANGS
              steps:
                - name: Checkout
                  uses: actions/checkout@v4
                - name: Initialize CodeQL
                  uses: github/codeql-action/init@v3
                  with:
                    languages: \${{ matrix.language }}
                - name: Autobuild
                  uses: github/codeql-action/autobuild@v3
                - name: Perform CodeQL Analysis
                  uses: github/codeql-action/analyze@v3
                  with:
                    category: "/language:\${{matrix.language}}"
          EOF

      - name: Commit & Push generated files
        run: |
          git config --global user.name "Security Bot"
          git config --global user.email "security@bot.com"
          git add .
          git commit -m "ðŸ¤– Setup Automatico Security (Snyk, Sonar, CodeQL)" || echo "Nessuna modifica da committare"
          git push
