name: ðŸ¶ Snyk Security
on:
  push:
    branches: [ "**" ]
    paths-ignore:
      - '.github/workflows/**'
      - 'sonar-project.properties'
      - '.snyk'
  pull_request:
    branches: [ "**" ]
    paths-ignore:
      - '.github/workflows/**'
      - 'sonar-project.properties'
      - '.snyk'
  workflow_dispatch:

jobs:
  snyk-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Snyk CLI & Reporter
      run: |
        npm install -g snyk snyk-to-html

    - name: Authenticate Snyk
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: snyk auth $SNYK_TOKEN

    - name: Snyk Security Scan & Report
      continue-on-error: false
      run: |
        
        # Run Snyk and save JSON (forcing root policy)
        snyk test --all-projects --policy-path=.snyk --severity-threshold=medium --json > snyk-results.json || true

        # Convert to HTML
        cat snyk-results.json | snyk-to-html -o snyk-report.html

        # Strict Blocking Logic
        python3 -c "
        import json, sys
        try:
           with open('snyk-results.json') as f:
               data = json.load(f)
           projects = data if isinstance(data, list) else [data]
           found = False
           for p in projects:
               if p.get('uniqueCount', 0) > 0:
                   found = True
                   break

           # If vulnerabilities exist and Blocking is enabled, FAIL the build
           if found and 'true' == 'true':
               print('::error::Blocking Pipeline: Snyk found security vulnerabilities!')
               sys.exit(1)
           elif found:
               print('::warning::Snyk found vulnerabilities (Blocking Disabled)')

        except Exception as e:
           print(e)
           # If checking fails but blocking is on, be safe and fail
           if 'true' == 'true':
              sys.exit(1)
        "
    

    - name: Upload HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: snyk-security-report
        path: snyk-report.html
